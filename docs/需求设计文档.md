# SolarArc Pro 需求设计文档

## 文档信息
- **项目名称**: SolarArc Pro —— 高性能城市时空日照分析与视觉仿真平台
- **文档版本**: v2.1
- **创建日期**: 2026-01-29
- **更新日期**: 2026-01-29
- **目标市场**: 中国国内用户
- **部署平台**: Zeabur
- **设计原则**: 全栈技术免费开源，优先使用高质量技术栈

---

## 一、项目概述

### 1.1 项目背景
SolarArc Pro 旨在为城市规划师、建筑师和开发商提供高精度的日照分析工具，通过科学算法计算建筑阴影、评估采光权，为城市建设决策提供数据支持。

### 1.2 核心目标
- **科学性**: 采用天文级太阳算法，保证计算精度达到角度秒级
- **高性能**: 支持1000+建筑的实时渲染与阴影分析
- **易用性**: 提供直观的可视化界面和交互式分析工具
- **经济性**: 全栈采用免费开源技术，降低部署成本

### 1.3 目标用户
- 城市规划部门
- 建筑设计事务所
- 房地产开发商
- 科研机构

### 1.4 中国市场特色功能

#### 1.4.1 坐标系支持
中国国内地图服务使用特殊的坐标系，系统需要支持：

1. **WGS84** - 全球标准坐标系（GPS原始坐标）
2. **GCJ-02** - 国测局坐标系（高德、腾讯地图使用）
3. **BD-09** - 百度坐标系（百度地图使用）

**坐标系转换功能**:
- 自动识别输入数据坐标系
- 实时坐标转换工具
- 批量坐标转换接口
- 偏移校正算法

#### 1.4.2 中国地图底图
- **高德地图** (GCJ-02) - 提供免费API，适合国内使用
- **腾讯地图** (GCJ-02) - 免费额度高，数据准确
- **OpenStreetMap** (WGS84) - 国际开源地图
- **天地图** - 国家测绘局官方地图，需备案

**推荐方案**: 高德地图 + MapLibre GL JS（自定义样式）

#### 1.4.3 中文本地化
- 完整简体中文界面
- 中国城市数据预置（300+城市）
- 中国时区自动处理（Asia/Shanghai UTC+8）
- 中国节假日和工作日识别
- 中文单位系统（米、平方米、摄氏度）

#### 1.4.4 中国日照标准
符合中国国家标准：
- **GB 50180-2018** 《城市居住区规划设计标准》
- **大寒日日照**: 住宅建筑大寒日日照时数≥2小时
- **冬至日日照**: 部分城市要求冬至日日照时数≥1小时
- **日照间距系数**: 不同纬度城市的建筑间距要求

#### 1.4.5 中国城市数据
- 预置中国主要城市太阳位置数据
- 支持中国行政区划代码（GB/T 2260）
- 城市经纬度数据库（精确到区县级）
- 中国建筑规范标准库

---

## 二、功能需求详细说明

### 2.1 用户认证模块

#### 2.1.1 注册功能
- **邮箱注册**
  - 支持用户通过邮箱进行注册
  - 邮箱格式验证（正则表达式校验）
  - 发送验证邮件，含激活链接（有效期24小时）
  - 密码强度要求：至少8位，包含字母和数字

- **注册信息字段**
  - 邮箱地址（登录账号）
  - 密码（使用 bcrypt 加密存储）
  - 用户昵称（可选）
  - 注册时间（自动记录）

#### 2.1.2 登录功能
- **邮箱密码登录**
  - 邮箱与密码匹配验证
  - 密码错误5次后账户临时锁定30分钟
  - 登录成功生成 JWT Token（有效期7天）

- **Token 机制**
  - 使用 JWT 进行身份验证
  - Token 存储在 localStorage 中
  - 请求头携带：`Authorization: Bearer <token>`

- **登录状态管理**
  - 记住登录状态（7天免登录）
  - 单点登录控制：同一账号仅允许一个活跃会话

#### 2.1.3 找回密码
- 通过邮箱发送密码重置链接
- 重置链接有效期1小时
- 设置新密码时需符合密码强度要求

#### 2.1.4 用户资料管理
- 查看和编辑个人资料
- 修改密码（需验证原密码）
- 邮箱变更（需验证新邮箱）

---

### 2.2 核心功能模块

#### 2.2.1 太阳位置计算模块
**功能描述**: 计算任意时间、地点的太阳位置参数

**详细需求**:
- 输入参数:
  - 经纬度 (全球范围, WGS84坐标系)
  - 日期时间 (支持历史与未来日期)
  - 时区 (自动处理夏令时)
- 输出参数:
  - 太阳高度角 (Solar Altitude Angle)
  - 太阳方位角 (Solar Azimuth Angle)
  - 日出日落时间
- 精度要求: 角度秒级误差 (< 3角秒)
- 算法选择: SPA (Solar Position Algorithm)
- 实现库: pvlib 或 astral

**技术实现**:
```python
# 依赖库
- pvlib: 用于太阳位置计算
- astral: 用于日出日落时间计算
- numpy: 用于向量运算
```

---

#### 2.2.2 3D建筑数据管理模块
**功能描述**: 管理城市建筑的几何信息与元数据

**数据结构**:
- 建筑底面: POLYGON (WGS84, SRID 4326)
- 建筑高度: Total_Height (单位: 米)
- 楼层面积: Floor_Area (单位: 平方米)
- 反射率: Reflective_Rate (0-1之间)
- 建筑类型: 住宅/商业/工业/公共设施

**功能列表**:
1. 建筑数据导入 (支持 GeoJSON/Shapefile/KML)
2. 建筑数据CRUD操作
3. 空间索引 (SPATIAL INDEX)
4. 视野范围查询 (Bounding Box查询)
5. 复杂多边形支持 (凹多边形验证)

---

#### 2.2.3 阴影计算引擎
**功能描述**: 计算建筑在任意时刻的投影阴影

**算法设计**:
- **基础算法**: Shadow Volume (阴影体积法)
- **核心原理**: 从3D建筑顶点沿太阳光线方向投影到地面平面

**计算流程**:
1. 获取太阳位置 (高度角、方位角)
2. 提取建筑顶点坐标
3. 计算太阳光线向量
4. 将顶点沿光线方向投影到Z=0平面
5. 生成阴影多边形 (支持凹多边形)
6. 处理多建筑阴影重叠 (Union操作)

**优化策略**:
- 预计算表: 对关键日期 (春分、夏至、秋分、冬至) 的每小时太阳位置预存
- 空间过滤: 仅计算视野内建筑的阴影
- 并行计算: 使用 Numpy 向量化运算

---

#### 2.2.4 日照分析模块
**功能描述**: 分析特定区域的日照时长与质量

**子功能**:

##### a) 有效日照时长统计
- 用户点击地图任意点
- 系统回溯该点在过去12小时被遮挡的频次
- 计算有效采光时长
- 可视化: 日照时间热力图

##### b) 阴影重叠分析 (Inter-Shadow Analysis)
- 区分"自阴影" (建筑自身的阴影)
- 区分"投射阴影" (其他建筑的投影)
- 计算阴影交集面积
- 应用场景: 评估新建建筑对既有社区的采光权侵犯

##### c) 极端气象节点对比
- 对比"冬至日" (阴影最长) vs "夏至日" (阴影最短)
- 支持一键切换显示
- 输出对比报告

---

#### 2.2.5 可视化与交互模块
**功能描述**: 提供高性能的3D可视化界面

**前端组件设计**:

##### 1) 地图渲染引擎
- 底图: Mapbox GL JS v3 (使用免费开源样式)
- 建筑渲染: Deck.gl MeshLayer / TripsLayer
- 阴影渲染: WebGL Shader (Shadow Mapping技术)

##### 2) 时间轴控件
- 24小时滑块
- 实时播放 (支持倍速: 1x, 2x, 5x, 10x)
- 关键时间点标记 (日出、正午、日落)

##### 3) 实时仪表盘
- 当前太阳高度角、方位角
- 即时阴影长度系数
- 选中建筑的日照统计

##### 4) 视图模式切换
- 地图模式: 显示真实地图底图
- 白模模式: 仅显示建筑3D模型,专注阴影对比
- 混合模式: 可调节底图透明度

---

### 2.3 移动端适配模块

#### 2.3.1 响应式布局设计
- **断点设计**
  - 移动端（小屏）：< 768px
  - 平板端（中屏）：768px - 1024px
  - 桌面端（大屏）：> 1024px

- **适配策略**
  - 移动优先设计（Mobile First）
  - CSS Grid + Flexbox 响应式布局
  - 触摸友好的交互设计（按钮最小点击区域 44x44px）
  - 横竖屏自动适配

#### 2.3.2 移动端交互优化
- **手势操作**
  - 双指缩放地图
  - 单指拖拽平移
  - 滑动切换时间轴
  - 长按查看建筑详情

- **触摸优化**
  - 防止误触：300ms 点击延迟处理
  - 惯性滚动优化
  - 下拉刷新、上拉加载
  - 触觉反馈（振动 API）

#### 2.3.3 移动端 UI 调整
- **导航优化**
  - 底部导航栏（Tab Bar）
  - 侧滑菜单（Drawer）
  - 返回按钮（手势返回支持）

- **界面简化**
  - 折叠式侧边栏
  - 浮动操作按钮（FAB）
  - 全屏地图模式
  - 简化表单输入（自动聚焦、键盘类型适配）

- **性能优化**
  - 图片懒加载
  - 虚拟滚动（长列表）
  - 减少渲染建筑数量（LOD 优化）
  - 触摸事件节流

#### 2.3.4 PWA 支持（渐进式 Web 应用）
- **离线功能**
  - Service Worker 缓存策略
  - 离线地图瓦片缓存
  - 离线数据同步（Queue Sync）

- **安装提示**
  - 添加到主屏幕（A2HS）
  - 自定义启动图标
  - 全屏显示模式

- **推送通知**
  - 分析完成通知
  - 系统消息推送

---

### 2.4 可视化分析统计模块

#### 2.4.1 日照统计图表
- **时间序列分析**
  - 24小时日照时长曲线图（折线图）
  - 月度日照对比柱状图
  - 季节性日照趋势面积图

- **太阳轨迹可视化**
  - 太阳路径图（Sun Path Diagram）
  - 立体投影太阳轨迹
  - 方位角-高度角极坐标图

#### 2.4.2 阴影覆盖分析
- **阴影热力图**
  - 区域阴影密度热力图
  - 动态阴影变化热力动画
  - 多时点阴影叠加分析

- **阴影范围统计**
  - 阴影面积饼图（按建筑）
  - 阴影重叠面积占比图
  - 阴影长度变化趋势图

#### 2.4.3 建筑采光评估报告
- **采光评分卡片**
  - 单建筑采光综合评分（0-100分）
  - 等级标识：优（≥80）、良（60-79）、中（40-59）、差（<40）
  - 评分构成：有效日照时长、阴影遮挡频次、采光均匀度

- **采光对比雷达图**
  - 多建筑采光维度对比
  - 维度：平均日照时长、峰值日照、连续日照、阴影遮挡

- **数据表格**
  - 建筑采光明细表
  - 支持排序、筛选、导出（CSV/Excel）

#### 2.4.4 数据导出功能
- **导出格式**
  - PDF 分析报告（含图表、地图截图）
  - Excel 数据表格
  - GeoJSON 矢量数据
  - PNG/JPG 高清图表导出

- **报告模板**
  - 自动生成专业报告
  - 包含：项目信息、分析方法、数据图表、结论建议
  - 支持自定义报告样式（Logo、配色）

#### 2.4.5 实时数据看板
- **关键指标卡片**
  - 当前太阳位置（高度角、方位角）
  - 区域平均采光指数
  - 最大阴影覆盖面积
  - 实时阴影长度系数

- **动态图表**
  - 实时阴影面积变化曲线
  - 采光进度环形图
  - 建筑遮挡关系桑基图

---

### 2.5 系统边界与限制

**当前版本不包括**:
- 气象数据集成 (云层遮挡)
- 室内采光分析
- 光伏发电量计算

**性能约束**:
- 首屏加载1000个建筑: < 1.5秒
- 阴影实时计算: < 100ms/帧
- 数据传输大小: < 5MB (压缩GeoJSON)

---

## 三、技术架构设计

### 3.1 整体架构
```
┌─────────────────────────────────────────────────────────────┐
│                        用户浏览器                             │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  前端 (React 18 + TypeScript + Vite)                  │  │
│  │  - Mapbox GL JS v3 (地图渲染)                         │  │
│  │  - Deck.gl (3D建筑与阴影)                             │  │
│  │  - Ant Design + Shadcn UI (组件库)                    │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              ↓ HTTPS (JSON)
┌─────────────────────────────────────────────────────────────┐
│  后端 (Python 3.10+ + FastAPI)                              │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  API层                                                 │  │
│  │  - 建筑数据接口 (CRUD)                                 │  │
│  │  - 太阳位置计算接口                                    │  │
│  │  - 阴影计算接口                                        │  │
│  │  - 日照分析接口                                        │  │
│  └───────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  业务逻辑层                                            │  │
│  │  - 太阳位置算法 (pvlib)                               │  │
│  │  - 阴影计算引擎 (shapely + numpy)                     │  │
│  │  - 空间运算 (shapely)                                  │  │
│  └───────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  数据访问层                                            │  │
│  │  - SQLAlchemy (ORM)                                   │  │
│  │  - GeoAlchemy2 (空间数据支持)                         │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  数据库 (MySQL 8.0+)                                        │
│  - InnoDB引擎 + SPATIAL INDEX                              │
│  - SRID 4326 (WGS84)                                       │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 技术栈选型 (全部免费开源)

#### 3.2.1 前端技术栈
| 技术 | 版本 | 用途 | 许可证 |
|------|------|------|--------|
| React | 18.x | 前端框架 | MIT |
| TypeScript | 5.x | 类型系统 | Apache 2.0 |
| Vite | 5.x | 构建工具 | MIT |
| Ant Design | 5.x | UI组件库（桌面端） | MIT |
| Ant Design Mobile | 5.x | 移动端UI组件 | MIT |
| Mapbox GL JS | 3.x | 地图渲染 | BSD-3-Clause |
| Deck.gl | 8.x | 3D数据可视化 | MIT |
| ECharts | 5.x | 数据可视化图表（免费） | Apache 2.0 |
| Recharts | 2.x | React图表组件（免费） | MIT |
| Shadcn UI | Latest | 高级UI组件 | MIT |
| TailwindCSS | 3.x | 样式框架 | MIT |
| Zustand | 4.x | 状态管理（轻量级） | MIT |
| React Query | 5.x | 数据请求 | MIT |
| PWACompat | Latest | PWA兼容性支持 | MIT |
| Workbox | 7.x | Service Worker工具 | Apache 2.0 |
| react-use-gesture | Latest | 手势操作库 | MIT |
| jspdf | 2.x | PDF导出（免费） | MIT |
| papaparse | 5.x | CSV解析（免费） | MIT |

**替代方案 (如Mapbox Token限制)**:
- 使用 OpenStreetMap 免费瓦片
- MapLibre GL JS (Mapbox的开源分支)

---

#### 3.2.2 后端技术栈
| 技术 | 版本 | 用途 | 许可证 |
|------|------|------|--------|
| Python | 3.10+ | 编程语言 | PSF |
| FastAPI | 0.104+ | Web框架 | MIT |
| uvicorn | 0.24+ | ASGI服务器 | BSD |
| pydantic | 2.x | 数据验证 | MIT |
| pvlib | 0.10+ | 太阳位置算法 | BSD 3-Clause |
| astral | 3.2+ | 日出日落计算 | Apache 2.0 |
| shapely | 2.x | 空间几何计算 | BSD 3-Clause |
| numpy | 1.24+ | 向量运算 | BSD |
| SQLAlchemy | 2.x | ORM | MIT |
| GeoAlchemy2 | 0.14+ | 空间数据ORM | MIT |
| pygeoif | 1.x | GeoJSON处理 | MIT |
| PyJWT | 2.8+ | JWT令牌生成（免费） | MIT |
| passlib | 1.7+ | 密码加密（免费） | BSD |
| python-jose | Latest | JWT处理（免费） | Apache 2.0 |
| python-multipart | Latest | 表单数据处理（免费） | Apache 2.0 |
| reportlab | Latest | PDF报告生成（免费） | BSD 3-Clause |
| openpyxl | Latest | Excel文件处理（免费） | MIT |

---

#### 3.2.3 数据库技术栈
| 技术 | 版本 | 用途 | 许可证 |
|------|------|------|--------|
| MySQL | 8.0+ | 关系型数据库 | GPL v2 |
| 注意: MySQL可在生产环境免费使用,无需付费 |

**替代方案 (如避免GPL)**:
- PostgreSQL 15+ + PostGIS (更强大的空间数据支持, MIT许可)

---

### 3.3 开发工具 (免费)
- **IDE**: VS Code
- **API测试**: Insomnia / Postman (免费版)
- **数据库管理**: DBeaver Community
- **版本控制**: Git + GitHub
- **CI/CD**: GitHub Actions (免费额度)

---

## 四、数据库设计

### 4.1 数据库选型
- **主选**: MySQL 8.0+ (InnoDB + Spatial Index)
- **备选**: PostgreSQL 15+ + PostGIS (推荐用于更复杂的空间查询)

### 4.2 核心表设计

#### 4.2.1 用户表 (users)
```sql
CREATE TABLE users (
    id VARCHAR(36) PRIMARY KEY COMMENT '用户ID（UUID）',
    email VARCHAR(255) UNIQUE NOT NULL COMMENT '邮箱（登录账号）',
    password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希（bcrypt）',
    nickname VARCHAR(50) COMMENT '用户昵称',

    -- 账户状态
    is_active BOOLEAN DEFAULT TRUE COMMENT '账户是否激活',
    is_locked BOOLEAN DEFAULT FALSE COMMENT '账户是否锁定',
    failed_login_count INT DEFAULT 0 COMMENT '失败登录次数',
    locked_until DATETIME COMMENT '锁定到期时间',

    -- 登录信息
    last_login_at TIMESTAMP NULL COMMENT '最后登录时间',
    last_login_ip VARCHAR(45) COMMENT '最后登录IP',

    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- 索引
    UNIQUE INDEX idx_email (email),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

#### 4.2.2 密码重置表 (password_resets)
```sql
CREATE TABLE password_resets (
    id VARCHAR(36) PRIMARY KEY COMMENT '重置ID（UUID）',
    user_id VARCHAR(36) NOT NULL COMMENT '用户ID',
    token VARCHAR(255) UNIQUE NOT NULL COMMENT '重置令牌',
    expires_at DATETIME NOT NULL COMMENT '过期时间',
    used BOOLEAN DEFAULT FALSE COMMENT '是否已使用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- 外键
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,

    -- 索引
    UNIQUE INDEX idx_token (token),
    INDEX idx_user_id (user_id),
    INDEX idx_expires_at (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='密码重置表';
```

---

#### 4.2.3 建筑表 (buildings)
```sql
CREATE TABLE buildings (
    id VARCHAR(36) PRIMARY KEY COMMENT '建筑ID（UUID）',
    name VARCHAR(255) COMMENT '建筑名称',
    building_type ENUM('residential', 'commercial', 'industrial', 'public') COMMENT '建筑类型',

    -- 空间几何数据
    footprint POLYGON NOT NULL SRID 4326 COMMENT '建筑底面多边形 (WGS84)',
    total_height DECIMAL(10, 2) NOT NULL COMMENT '总高度(米)',
    floor_area DECIMAL(15, 2) COMMENT '楼层面积(平方米)',
    floor_count INT COMMENT '楼层数',

    -- 光学属性
    reflective_rate DECIMAL(3, 2) DEFAULT 0.3 COMMENT '反射率(0-1)',

    -- 元数据
    address VARCHAR(500),
    district VARCHAR(100),
    city VARCHAR(100) DEFAULT '未知城市',
    country VARCHAR(50) DEFAULT 'China',

    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- 空间索引
    SPATIAL INDEX idx_footprint (footprint)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='建筑信息表';
```

---

#### 4.2.4 太阳位置预计算表 (solar_positions_precalc)
```sql
CREATE TABLE solar_positions_precalc (
    id VARCHAR(36) PRIMARY KEY COMMENT '记录ID（UUID）',

    -- 位置参数
    latitude DECIMAL(10, 6) NOT NULL COMMENT '纬度',
    longitude DECIMAL(10, 6) NOT NULL COMMENT '经度',

    -- 时间参数
    date DATE NOT NULL COMMENT '日期',
    hour TINYINT NOT NULL COMMENT '小时(0-23)',

    -- 太阳位置参数
    altitude_angle DECIMAL(10, 6) NOT NULL COMMENT '太阳高度角(度)',
    azimuth_angle DECIMAL(10, 6) NOT NULL COMMENT '太阳方位角(度)',

    -- 索引
    UNIQUE KEY idx_location_datetime (latitude, longitude, date, hour),
    INDEX idx_date (date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='太阳位置预计算表';
```

**说明**:
- 仅预计算关键日期: 春分、夏至、秋分、冬至
- 其他日期通过算法实时计算
- 使用 pvlib 的 `solarposition.get_solarposition()` 函数

---

#### 4.2.5 阴影分析记录表 (shadow_analysis_cache)
```sql
CREATE TABLE shadow_analysis_cache (
    id VARCHAR(36) PRIMARY KEY COMMENT '缓存ID（UUID）',

    -- 分析参数
    building_id VARCHAR(36) NOT NULL,
    analysis_date DATE NOT NULL,
    analysis_hour TINYINT NOT NULL,

    -- 计算结果 (存储为GeoJSON)
    shadow_polygon POLYGON NOT NULL SRID 4326 COMMENT '阴影多边形',
    shadow_area DECIMAL(15, 2) COMMENT '阴影面积(平方米)',

    -- 缓存元数据
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NOT NULL COMMENT '缓存过期时间',

    -- 外键
    FOREIGN KEY (building_id) REFERENCES buildings(id) ON DELETE CASCADE,

    -- 索引
    INDEX idx_building_datetime (building_id, analysis_date, analysis_hour),
    INDEX idx_expires (expires_at),
    SPATIAL INDEX idx_shadow (shadow_polygon)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='阴影分析缓存表';
```

---

#### 4.2.6 项目表 (projects) - 用户保存的分析项目
```sql
CREATE TABLE projects (
    id VARCHAR(36) PRIMARY KEY COMMENT '项目ID（UUID）',
    user_id VARCHAR(36) NOT NULL COMMENT '用户ID',
    name VARCHAR(255) NOT NULL COMMENT '项目名称',
    description TEXT COMMENT '项目描述',
    center_latitude DECIMAL(10, 7) NOT NULL COMMENT '中心纬度',
    center_longitude DECIMAL(10, 7) NOT NULL COMMENT '中心经度',
    zoom_level INT DEFAULT 15 COMMENT '缩放级别',
    config JSON COMMENT '配置参数',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- 外键
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,

    -- 索引
    INDEX idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户项目表';
```

#### 4.2.7 分析报告表 (analysis_reports) - 存储可视化分析结果
```sql
CREATE TABLE analysis_reports (
    id VARCHAR(36) PRIMARY KEY COMMENT '报告ID（UUID）',
    user_id VARCHAR(36) NOT NULL COMMENT '用户ID',
    project_id VARCHAR(36) COMMENT '关联项目ID',
    name VARCHAR(255) NOT NULL COMMENT '报告名称',
    analysis_type ENUM('daily', 'seasonal', 'custom') NOT NULL COMMENT '分析类型',
    latitude DECIMAL(10, 7) NOT NULL COMMENT '分析中心纬度',
    longitude DECIMAL(10, 7) NOT NULL COMMENT '分析中心经度',
    date_start DATE NOT NULL COMMENT '分析开始日期',
    date_end DATE NOT NULL COMMENT '分析结束日期',
    total_sunlight_hours DECIMAL(10, 2) COMMENT '总日照时长',
    avg_shadow_coverage DECIMAL(5, 2) COMMENT '平均阴影覆盖率（%）',
    building_count INT COMMENT '分析建筑数量',
    results JSON NOT NULL COMMENT '详细分析结果（图表数据）',
    report_file_path VARCHAR(500) COMMENT 'PDF报告文件路径',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- 外键
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE SET NULL,

    -- 索引
    INDEX idx_user_id (user_id),
    INDEX idx_project_id (project_id),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='分析报告表';
```

#### 4.2.8 建筑采光评分表 (building_scores) - 存储建筑采光评估数据
```sql
CREATE TABLE building_scores (
    id VARCHAR(36) PRIMARY KEY COMMENT '评分ID（UUID）',
    report_id VARCHAR(36) NOT NULL COMMENT '关联报告ID',
    building_id VARCHAR(36) NOT NULL COMMENT '建筑ID',
    overall_score INT NOT NULL COMMENT '综合评分（0-100）',
    grade ENUM('excellent', 'good', 'moderate', 'poor') NOT NULL COMMENT '等级',
    avg_sunlight_hours DECIMAL(10, 2) COMMENT '平均日照时长',
    peak_sunlight_hours DECIMAL(10, 2) COMMENT '峰值日照时长',
    continuous_sunlight_hours DECIMAL(10, 2) COMMENT '最长连续日照时长',
    shadow_frequency INT COMMENT '被遮挡频次',
    shading_buildings JSON COMMENT '遮挡源建筑ID列表',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- 外键
    FOREIGN KEY (report_id) REFERENCES analysis_reports(id) ON DELETE CASCADE,
    FOREIGN KEY (building_id) REFERENCES buildings(id) ON DELETE CASCADE,

    -- 索引
    INDEX idx_report_id (report_id),
    INDEX idx_building_id (building_id),
    INDEX idx_overall_score (overall_score)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='建筑采光评分表';
```

---

#### 4.2.9 用户配置表 (user_settings)
```sql
CREATE TABLE user_settings (
    id VARCHAR(36) PRIMARY KEY COMMENT '配置ID（UUID）',
    session_id VARCHAR(128) NOT NULL COMMENT '前端会话ID',
    user_id VARCHAR(36) COMMENT '用户ID（关联用户，可选）',

    -- 地图状态
    map_center_lat DECIMAL(10, 6),
    map_center_lng DECIMAL(10, 6),
    map_zoom TINYINT,

    -- 分析参数
    analysis_date DATE,
    current_hour TINYINT,

    -- 时间戳
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- 外键
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,

    UNIQUE KEY idx_session (session_id),
    INDEX idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户配置表';
```

---

### 4.3 数据库优化策略

#### 4.3.1 空间索引
```sql
-- 创建空间索引
CREATE SPATIAL INDEX idx_footprint ON buildings(footprint);
CREATE SPATIAL INDEX idx_shadow ON shadow_analysis_cache(shadow_polygon);
```

#### 4.3.2 查询优化 (Bounding Box)
```sql
-- 仅查询视野范围内的建筑
SELECT * FROM buildings
WHERE MBRContains(
    ST_GeomFromText(
        'POLYGON((min_lng min_lat, max_lng min_lat, max_lng max_lat, min_lng max_lat, min_lng min_lat))',
        4326
    ),
    footprint
);
```

#### 4.3.3 数据分区
```sql
-- 按日期分区阴影缓存表
ALTER TABLE shadow_analysis_cache
PARTITION BY RANGE (TO_DAYS(analysis_date)) (
    PARTITION p_2025 VALUES LESS THAN (TO_DAYS('2026-01-01')),
    PARTITION p_2026 VALUES LESS THAN (TO_DAYS('2027-01-01'))
);
```

---

## 五、API接口设计

### 5.1 API规范
- **协议**: HTTPS
- **数据格式**: JSON
- **认证**: JWT Token (用户特定功能)
- **基础路径**: `/api/v1`

### 5.2 用户认证 API

#### 5.2.1 注册
```http
POST /api/v1/auth/register
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password123",
  "nickname": "张三"  // 可选
}
```

**响应 201**:
```json
{
  "code": 201,
  "message": "注册成功，请查收验证邮件",
  "data": {
    "user_id": 123
  }
}
```

#### 5.2.2 登录
```http
POST /api/v1/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password123"
}
```

**响应 200**:
```json
{
  "code": 200,
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "bearer",
    "expires_in": 604800,
    "user": {
      "id": 123,
      "email": "user@example.com",
      "nickname": "张三"
    }
  }
}
```

#### 5.2.3 获取当前用户信息
```http
GET /api/v1/auth/me
Authorization: Bearer <token>
```

**响应 200**:
```json
{
  "code": 200,
  "data": {
    "id": 123,
    "email": "user@example.com",
    "nickname": "张三",
    "created_at": "2024-01-01T00:00:00Z",
    "last_login_at": "2024-01-15T10:30:00Z"
  }
}
```

#### 5.2.4 退出登录
```http
POST /api/v1/auth/logout
Authorization: Bearer <token>
```

**响应 200**:
```json
{
  "code": 200,
  "message": "退出成功"
}
```

#### 5.2.5 修改密码
```http
PUT /api/v1/auth/change-password
Authorization: Bearer <token>
Content-Type: application/json

{
  "old_password": "oldpass123",
  "new_password": "newpass456"
}
```

#### 5.2.6 发送密码重置邮件
```http
POST /api/v1/auth/forgot-password
Content-Type: application/json

{
  "email": "user@example.com"
}
```

#### 5.2.7 重置密码
```http
POST /api/v1/auth/reset-password
Content-Type: application/json

{
  "token": "reset_token_here",
  "new_password": "newpass123"
}
```

---

### 5.3 核心功能 API

#### 5.3.1 建筑数据接口

##### 1) 获取视野内建筑列表
```http
GET /api/v1/buildings/bbox
```

**Query参数**:
```
min_lat: 纬度最小值
max_lat: 纬度最大值
min_lng: 经度最小值
max_lng: 经度最大值
include_shadow: 是否包含阴影 (boolean, 默认false)
analysis_date: 分析日期 (YYYY-MM-DD, 可选)
analysis_hour: 分析小时 (0-23, 可选)
```

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "buildings": [
      {
        "id": 1,
        "name": "万科中心",
        "footprint": {
          "type": "Polygon",
          "coordinates": [[...]]
        },
        "height": 120.5,
        "floor_area": 45000.0,
        "shadow": null
      }
    ],
    "total": 850
  }
}
```

---

##### 2) 获取单个建筑详情
```http
GET /api/v1/buildings/{id}
```

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "id": 1,
    "name": "万科中心",
    "building_type": "commercial",
    "footprint": {...},
    "height": 120.5,
    "floor_area": 45000.0,
    "floor_count": 30,
    "reflective_rate": 0.35,
    "address": "深圳市南山区..."
  }
}
```

---

##### 3) 创建/导入建筑数据
```http
POST /api/v1/buildings/import
Content-Type: multipart/form-data
```

**Body参数**:
```
file: GeoJSON/Shapefile/KML文件
city: 城市名称
```

**响应**:
```json
{
  "code": 201,
  "data": {
    "success_count": 1250,
    "failed_count": 3,
    "errors": [...]
  }
}
```

---

#### 5.3.2 太阳位置计算接口

##### 1) 实时计算太阳位置
```http
GET /api/v1/solar/position
```

**Query参数**:
```
lat: 纬度
lng: 经度
date: 日期 (YYYY-MM-DD, 默认当天)
hour: 小时 (0-23, 默认当前时间)
minute: 分钟 (0-59, 默认0)
timezone: 时区 (如 Asia/Shanghai)
```

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "solar_altitude": 45.678,
    "solar_azimuth": 180.234,
    "sunrise_time": "06:32:00",
    "sunset_time": "18:45:00",
    "day_length": 12.22,
    "timestamp": "2026-01-29T12:00:00+08:00"
  }
}
```

---

##### 2) 批量获取24小时太阳位置
```http
GET /api/v1/solar/daily-positions
```

**Query参数**:
```
lat: 纬度
lng: 经度
date: 日期 (YYYY-MM-DD, 默认当天)
```

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "date": "2026-01-29",
    "positions": [
      {"hour": 0, "altitude": -60.5, "azimuth": 0.0},
      {"hour": 6, "altitude": 5.2, "azimuth": 110.3},
      {"hour": 12, "altitude": 45.6, "azimuth": 180.2},
      ...
    ]
  }
}
```

---

#### 5.3.3 阴影计算接口

##### 1) 计算单个建筑阴影
```http
POST /api/v1/shadows/calculate
```

**Body参数**:
```json
{
  "building_ids": [1, 2, 3],
  "date": "2026-01-29",
  "hour": 12,
  "minute": 0
}
```

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "shadows": [
      {
        "building_id": 1,
        "shadow_polygon": {
          "type": "Polygon",
          "coordinates": [[...]]
        },
        "area": 1250.5
      }
    ],
    "calculation_time_ms": 45
  }
}
```

---

##### 2) 获取关键日期阴影对比
```http
GET /api/v1/shadows/compare-extremes
```

**Query参数**:
```
building_id: 建筑ID
hour: 小时 (默认12, 即正午)
```

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "winter_solstice": {
      "date": "2025-12-22",
      "shadow_polygon": {...},
      "shadow_length_coefficient": 3.5
    },
    "summer_solstice": {
      "date": "2026-06-21",
      "shadow_polygon": {...},
      "shadow_length_coefficient": 0.8
    },
    "ratio": 4.375
  }
}
```

---

#### 5.2.4 日照分析接口

##### 1) 查询指定点的有效日照时长
```http
POST /api/v1/analysis/point-sunlight
```

**Body参数**:
```json
{
  "point": {
    "lat": 22.5431,
    "lng": 114.0579
  },
  "date": "2026-01-29",
  "start_hour": 6,
  "end_hour": 18
}
```

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "total_hours": 12,
    "sunlight_hours": 8.5,
    "sunlight_rate": 0.708,
    "hourly_breakdown": [
      {"hour": 6, "is_sunny": true},
      {"hour": 7, "is_sunny": true},
      {"hour": 8, "is_sunny": false, "blocked_by": "building_123"},
      ...
    ]
  }
}
```

---

##### 2) 阴影重叠分析
```http
POST /api/v1/analysis/shadow-overlap
```

**Body参数**:
```json
{
  "target_building_id": 1,
  "surrounding_building_ids": [2, 3, 4, 5],
  "date": "2026-01-29",
  "hour": 12
}
```

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "self_shadow_area": 500.0,
    "projected_shadow_area": 1800.0,
    "overlap_area": 250.0,
    "overlap_details": [
      {
        "building_id": 2,
        "overlap_area": 150.0
      },
      {
        "building_id": 3,
        "overlap_area": 100.0
      }
    ]
  }
}
```

#### 5.3.4 日照分析接口

##### 1) 查询指定点的有效日照时长
```http
POST /api/v1/analysis/point-sunlight
```

**Body参数**:
```json
{
  "point": {
    "lat": 22.5431,
    "lng": 114.0579
  },
  "date": "2026-01-29",
  "start_hour": 6,
  "end_hour": 18
}
```

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "total_hours": 12,
    "sunlight_hours": 8.5,
    "sunlight_rate": 0.708,
    "hourly_breakdown": [
      {"hour": 6, "is_sunny": true},
      {"hour": 7, "is_sunny": true},
      {"hour": 8, "is_sunny": false, "blocked_by": "building_123"},
      ...
    ]
  }
}
```

##### 2) 阴影重叠分析
```http
POST /api/v1/analysis/shadow-overlap
```

**Body参数**:
```json
{
  "target_building_id": 1,
  "surrounding_building_ids": [2, 3, 4, 5],
  "date": "2026-01-29",
  "hour": 12
}
```

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "self_shadow_area": 500.0,
    "projected_shadow_area": 1800.0,
    "overlap_area": 250.0,
    "overlap_details": [
      {
        "building_id": 2,
        "overlap_area": 150.0
      },
      {
        "building_id": 3,
        "overlap_area": 100.0
      }
    ]
  }
}
```

---

### 5.4 可视化分析统计 API

#### 5.4.1 创建分析报告
```http
POST /api/v1/analysis/reports
Authorization: Bearer <token>
Content-Type: application/json

{
  "project_id": 1,
  "name": "2024年夏季日照分析报告",
  "analysis_type": "seasonal",
  "latitude": 39.9042,
  "longitude": 116.4074,
  "date_start": "2024-06-01",
  "date_end": "2024-08-31",
  "building_ids": [1, 2, 3, 4, 5]
}
```

**响应 201**:
```json
{
  "code": 201,
  "data": {
    "id": 123,
    "name": "2024年夏季日照分析报告",
    "status": "processing",
    "created_at": "2024-01-15T10:30:00Z"
  }
}
```

#### 5.4.2 获取分析报告列表
```http
GET /api/v1/analysis/reports
Authorization: Bearer <token>
Query参数:
  - page: 页码（默认1）
  - page_size: 每页数量（默认20）
  - project_id: 项目ID筛选（可选）
```

**响应 200**:
```json
{
  "code": 200,
  "data": {
    "total": 45,
    "page": 1,
    "page_size": 20,
    "reports": [
      {
        "id": 123,
        "name": "2024年夏季日照分析报告",
        "analysis_type": "seasonal",
        "total_sunlight_hours": 1250.5,
        "avg_shadow_coverage": 35.2,
        "status": "completed",
        "created_at": "2024-01-15T10:30:00Z"
      }
    ]
  }
}
```

#### 5.4.3 获取分析报告详情
```http
GET /api/v1/analysis/reports/{report_id}
Authorization: Bearer <token>
```

**响应 200**:
```json
{
  "code": 200,
  "data": {
    "id": 123,
    "name": "2024年夏季日照分析报告",
    "analysis_type": "seasonal",
    "latitude": 39.9042,
    "longitude": 116.4074,
    "date_start": "2024-06-01",
    "date_end": "2024-08-31",
    "total_sunlight_hours": 1250.5,
    "avg_shadow_coverage": 35.2,
    "building_count": 5,
    "results": {
      "hourly_sunlight": [...],
      "sun_path_data": [...],
      "shadow_heatmap": [...],
      "building_scores": [...]
    },
    "created_at": "2024-01-15T10:30:00Z"
  }
}
```

#### 5.4.4 获取建筑采光评分
```http
GET /api/v1/analysis/reports/{report_id}/building-scores
Authorization: Bearer <token>
```

**响应 200**:
```json
{
  "code": 200,
  "data": {
    "report_id": 123,
    "buildings": [
      {
        "building_id": 1,
        "building_name": "A栋",
        "overall_score": 85,
        "grade": "excellent",
        "avg_sunlight_hours": 8.5,
        "peak_sunlight_hours": 12.0,
        "continuous_sunlight_hours": 6.0,
        "shadow_frequency": 2,
        "shading_buildings": [2, 3]
      }
    ]
  }
}
```

#### 5.4.5 导出分析报告（PDF）
```http
GET /api/v1/analysis/reports/{report_id}/export
Authorization: Bearer <token>
Query参数:
  - format: 导出格式 pdf / excel / csv（默认pdf）
```

**响应 200**:
```
Content-Type: application/pdf
Content-Disposition: attachment; filename="report_123.pdf"

[二进制文件流]
```

#### 5.4.6 获取图表数据（供前端渲染）
```http
GET /api/v1/analysis/reports/{report_id}/charts/{chart_type}
Authorization: Bearer <token>
Query参数:
  - chart_type: 图表类型
    - hourly_sunlight（24小时日照曲线）
    - monthly_comparison（月度对比）
    - sun_path（太阳轨迹）
    - shadow_heatmap（阴影热力图）
    - building_radar（建筑采光雷达图）
```

**响应 200 (hourly_sunlight 示例)**:
```json
{
  "code": 200,
  "data": {
    "chart_type": "hourly_sunlight",
    "data": {
      "x_axis": [0, 1, 2, ..., 23],
      "series": [
        {
          "name": "A栋",
          "data": [0, 0, 0, 0, 0.5, 2.0, ..., 0]
        },
        {
          "name": "B栋",
          "data": [0, 0, 0, 0, 0, 1.5, ..., 0]
        }
      ]
    }
  }
}
```

#### 5.4.7 删除分析报告
```http
DELETE /api/v1/analysis/reports/{report_id}
Authorization: Bearer <token>
```

**响应 200**:
```json
{
  "code": 200,
  "message": "报告删除成功"
}
```

---

### 5.5 API错误处理规范

**错误响应格式**:
```json
{
  "code": 400,
  "error": "INVALID_PARAMETER",
  "message": "经纬度参数无效",
  "details": {
    "field": "lat",
    "reason": "must be between -90 and 90"
  }
}
```

**HTTP状态码**:
- 200: 成功
- 400: 参数错误
- 404: 资源不存在
- 500: 服务器内部错误

---

## 六、前端架构设计

### 6.1 项目结构
```
solararc-pro-frontend/
├── src/
│   ├── components/          # 通用组件
│   │   ├── MapView/        # 地图视图组件
│   │   ├── Timeline/       # 时间轴组件
│   │   ├── Dashboard/      # 仪表盘组件
│   │   └── BuildingCard/   # 建筑信息卡片
│   ├── pages/              # 页面组件
│   │   ├── HomePage.tsx
│   │   ├── AnalysisPage.tsx
│   │   └── SettingsPage.tsx
│   ├── hooks/              # 自定义Hooks
│   │   ├── useSolarPosition.ts
│   │   ├── useShadowCalculation.ts
│   │   └── useMapBounds.ts
│   ├── services/           # API服务
│   │   └── api.ts
│   ├── store/              # 状态管理
│   │   └── useAppStore.ts
│   ├── utils/              # 工具函数
│   │   ├── geo.ts
│   │   └── date.ts
│   └── types/              # TypeScript类型定义
│       └── index.ts
├── public/                 # 静态资源
├── vite.config.ts
└── package.json
```

---

### 6.2 核心组件设计

#### 6.2.1 MapView 组件
**职责**: 渲染地图与3D建筑

**技术实现**:
```tsx
// MapView.tsx
import MapboxGL from 'mapbox-gl';
import { ScatterplotLayer, PolygonLayer } from 'deck.gl';

const MapView: React.FC = () => {
  const mapRef = useRef<MapboxGL.Map>(null);

  const layers = [
    // 建筑底面
    new PolygonLayer({
      id: 'building-footprints',
      data: buildings,
      getPolygon: (d) => d.footprint.coordinates,
      getFillColor: [200, 200, 200, 180],
    }),

    // 建筑高度 (通过 Extrusion)
    new PolygonLayer({
      id: 'building-3d',
      data: buildings,
      getPolygon: (d) => d.footprint.coordinates,
      getElevation: (d) => d.height,
      getFillColor: [255, 255, 255, 200],
      material: {
        ambient: 0.5,
        diffuse: 0.5,
        shininess: 10
      }
    }),

    // 阴影层
    new PolygonLayer({
      id: 'shadows',
      data: shadows,
      getPolygon: (d) => d.polygon.coordinates,
      getFillColor: [0, 0, 0, 100], // 半透明黑色
    })
  ];

  return (
    <DeckGL
      initialViewState={viewport}
      layers={layers}
      controller
    >
      <MapboxGLMap
        ref={mapRef}
        mapStyle="mapbox://styles/mapbox/streets-v11"
      />
    </DeckGL>
  );
};
```

---

#### 6.2.2 Timeline 组件
**职责**: 24小时时间轴控制

**功能**:
- 滑块拖动选择时间
- 播放/暂停按钮
- 倍速选择 (1x, 2x, 5x, 10x)
- 关键时间点标记 (日出、正午、日落)

**状态管理**:
```tsx
// useTimelineStore.ts
interface TimelineState {
  currentHour: number;       // 0-23
  isPlaying: boolean;
  playbackSpeed: number;      // 1, 2, 5, 10
}

const useTimelineStore = create<TimelineState>((set) => ({
  currentHour: 12,
  isPlaying: false,
  playbackSpeed: 1,

  setHour: (hour) => set({ currentHour: hour }),
  togglePlay: () => set((state) => ({ isPlaying: !state.isPlaying })),
  setSpeed: (speed) => set({ playbackSpeed: speed }),
}));
```

---

#### 6.2.3 Dashboard 组件
**职责**: 显示实时太阳参数

**布局**:
```
┌─────────────────────────────────────┐
│  太阳高度角: 45.6°                   │
│  太阳方位角: 180.2°                  │
│  阴影长度系数: 1.2x                  │
│  当前时间: 2026-01-29 12:00          │
└─────────────────────────────────────┘
```

**实现**:
```tsx
// Dashboard.tsx
import { Card, Statistic } from 'antd';
import { useSolarPosition } from '@/hooks/useSolarPosition';

const Dashboard: React.FC = () => {
  const { data: solarData } = useSolarPosition();

  return (
    <div className="dashboard">
      <Card>
        <Statistic
          title="太阳高度角"
          value={solarData?.altitude}
          suffix="°"
          precision={1}
        />
      </Card>
      <Card>
        <Statistic
          title="太阳方位角"
          value={solarData?.azimuth}
          suffix="°"
          precision={1}
        />
      </Card>
    </div>
  );
};
```

---

### 6.3 状态管理 (Zustand)

#### 6.3.1 全局Store
```tsx
// useAppStore.ts
interface AppState {
  // 地图状态
  viewport: {
    latitude: number;
    longitude: number;
    zoom: number;
  };

  // 分析参数
  analysisDate: Date;
  currentHour: number;

  // 数据
  buildings: Building[];
  shadows: Shadow[];

  // UI状态
  viewMode: 'map' | 'white-model' | 'hybrid';
  isLoading: boolean;

  // Actions
  setViewport: (viewport: Partial<AppState['viewport']>) => void;
  setBuildings: (buildings: Building[]) => void;
  setAnalysisDate: (date: Date) => void;
  setCurrentHour: (hour: number) => void;
}

export const useAppStore = create<AppState>((set) => ({
  viewport: {
    latitude: 22.5431,
    longitude: 114.0579,
    zoom: 15,
  },
  analysisDate: new Date(),
  currentHour: 12,
  buildings: [],
  shadows: [],
  viewMode: 'map',
  isLoading: false,

  setViewport: (viewport) =>
    set((state) => ({ viewport: { ...state.viewport, ...viewport } })),
  setBuildings: (buildings) => set({ buildings }),
  setAnalysisDate: (date) => set({ analysisDate: date }),
  setCurrentHour: (hour) => set({ currentHour: hour }),
}));
```

---

### 6.4 数据请求策略 (React Query)

```tsx
// hooks/useBuildingData.ts
import { useQuery } from '@tanstack/react-query';
import { api } from '@/services/api';

export const useBuildingsInBounds = (bounds: MapBounds) => {
  return useQuery({
    queryKey: ['buildings', bounds],
    queryFn: () =>
      api.get('/buildings/bbox', {
        params: {
          min_lat: bounds.minLat,
          max_lat: bounds.maxLat,
          min_lng: bounds.minLng,
          max_lng: bounds.maxLng,
        },
      }),
    staleTime: 5 * 60 * 1000, // 5分钟内不重新请求
    cacheTime: 10 * 60 * 1000, // 缓存10分钟
  });
};
```

---

### 6.5 性能优化

#### 6.5.1 建筑数据分级加载 (LOD)
```tsx
// 根据缩放级别加载不同详细程度的建筑
const useLODBuildings = (zoom: number) => {
  const query = useBuildingsInBounds(bounds);

  if (zoom < 14) {
    // 只显示高度>50米的建筑
    return query.data?.filter(b => b.height > 50);
  } else if (zoom < 16) {
    // 显示高度>20米的建筑
    return query.data?.filter(b => b.height > 20);
  } else {
    // 显示所有建筑
    return query.data;
  }
};
```

#### 6.5.2 阴影按需计算
```tsx
// 仅当时间变化时重新计算阴影
const useShadows = (buildings: Building[], date: Date, hour: number) => {
  return useQuery({
    queryKey: ['shadows', buildings.map(b => b.id), date, hour],
    queryFn: () => calculateShadows(buildings, date, hour),
    enabled: buildings.length > 0, // 有建筑数据时才启用
    staleTime: 10 * 60 * 1000, // 10分钟内复用缓存
  });
};
```

#### 6.5.3 数据压缩传输
```tsx
// 使用 GeoJSON 的压缩格式
import { Pack } from 'geotiff';

const compressedGeoJSON = Pack(geojsonData);
```

---

## 七、部署方案 - Zeabur平台

### 7.1 Zeabur平台介绍

**Zeabur** 是新一代应用部署平台，专门为中国开发者优化：

#### 7.1.1 为什么选择Zeabur？
- ✅ **国内访问速度快**: 部署在国内云服务商（阿里云、腾讯云）
- ✅ **完全免费额度**: 每月 $5 免费额度（约256MB RAM持续运行）
- ✅ **中文界面**: 完整中文支持，符合国内用户使用习惯
- ✅ **原生支持Docker**: 直接使用Dockerfile或docker-compose.yml
- ✅ **自动CI/CD**: 连接GitHub，自动部署代码
- ✅ **预构建数据库**: 支持MySQL、PostgreSQL、Redis、MongoDB
- ✅ **国内友好**: 支持国内域名备案，无需翻墙访问
- ✅ **自动HTTPS**: 自动申请和续期SSL证书（Let's Encrypt）

#### 7.1.2 Zeabur免费额度详情
| 资源 | 免费额度 |
|------|----------|
| CPU | 0.2 vCPU |
| 内存 | 256MB RAM |
| 存储 | 1GB 持久化存储 |
| 带宽 | 50GB/月 |
| 数据库 | MySQL/PostgreSQL 各1个实例 |

**适合**: 中小型项目、个人作品集、演示环境

---

### 7.2 Zeabur部署架构

```
┌─────────────────────────────────────────────────────────┐
│                  Zeabur 平台                            │
│                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  前端服务    │  │  后端API     │  │  MySQL数据库 │  │
│  │  (Nginx)     │  │  (FastAPI)   │  │  (Zeabur)    │  │
│  │              │  │              │  │              │  │
│  │  - 静态资源  │  │  - REST API  │  │  - 持久化    │  │
│  │  - SPA路由   │  │  - 计算引擎  │  │  - 自动备份  │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│         │                 │                 │            │
│         └─────────────────┴─────────────────┘            │
│                           │                             │
│                   ┌───────▼────────┐                    │
│                   │  自动HTTPS     │                    │
│                   │  (Let's Encrypt)│                   │
│                   └────────────────┘                    │
└─────────────────────────────────────────────────────────┘
                           │
                    ┌──────▼─────────┐
                    │  域名访问      │
                    │  .zeabur.app   │
                    │  或自定义域名  │
                    └────────────────┘
```

---

### 7.3 部署准备

#### 7.3.1 注册Zeabur账号
1. 访问 [zeabur.com](https://zeabur.com)
2. 使用GitHub登录（推荐）
3. 创建新项目
4. 记录项目ID和API密钥

#### 7.3.2 项目结构准备
```
solararc-pro/
├── backend/                 # 后端代码
│   ├── Dockerfile
│   ├── requirements.txt
│   └── app/
├── frontend/               # 前端代码
│   ├── Dockerfile
│   ├── package.json
│   └── src/
├── zeabur.yml             # Zeabur配置文件
└── .env.example           # 环境变量模板
```

---

### 7.4 核心配置文件

#### 7.4.1 后端 Dockerfile (backend/Dockerfile)
```dockerfile
# 使用官方Python镜像
FROM python:3.10-slim

# 设置工作目录
WORKDIR /app

# 安装系统依赖（空间计算所需）
RUN apt-get update && apt-get install -y \
    gcc \
    libgeos-dev \
    libproj-dev \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY requirements.txt .

# 安装Python依赖
RUN pip install --no-cache-dir -r requirements.txt \
    && pip install gunicorn

# 复制应用代码
COPY . .

# 暴露端口
EXPOSE 8000

# 启动命令（生产环境使用gunicorn）
CMD ["gunicorn", "main:app", "--bind", "0.0.0.0:8000", "--workers", "2"]
```

#### 7.4.2 后端 requirements.txt
```txt
fastapi==0.104.1
uvicorn[standard]==0.24.0
pydantic==2.5.0
pydantic-settings==2.1.0

# 数据库
sqlalchemy==2.0.23
geoalchemy2==0.14.2
pymysql==1.1.0
cryptography==41.0.7

# 空间计算
shapely==2.0.2
numpy==1.26.2
pvlib==0.10.3
astral==3.2

# 工具
python-dotenv==1.0.0
python-multipart==0.0.6

# CORS
python-jose[cryptography]==3.3.0
```

#### 7.4.3 前端 Dockerfile (frontend/Dockerfile)
```dockerfile
# 多阶段构建：构建阶段
FROM node:18-alpine AS builder

WORKDIR /app

# 复制依赖文件
COPY package*.json ./

# 安装依赖（使用国内镜像）
RUN npm config set registry https://registry.npmmirror.com
RUN npm ci

# 复制源代码
COPY . .

# 构建生产版本
RUN npm run build

# 生产阶段：使用Nginx
FROM nginx:alpine

# 复制构建产物
COPY --from=builder /app/dist /usr/share/nginx/html

# 复制Nginx配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

#### 7.4.4 前端 Nginx配置 (frontend/nginx.conf)
```nginx
server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # Gzip压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # SPA路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API代理（可选，如果前后端在同一域名）
    location /api/ {
        proxy_pass http://backend:8000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

#### 7.4.5 Zeabur配置文件 (zeabur.yml)
```yaml
# Zeabur部署配置
version: 1

# MySQL数据库
databases:
  - name: solararc-mysql
    type: mysql
    version: "8.0"

# 后端服务
services:
  - name: backend
    type: container
    source: ./backend
    dockerfile: Dockerfile
    ports:
      - port: 8000
        type: HTTP
    env:
      - DATABASE_URL=mysql://root:${MYSQL_PASSWORD}@solararc-mysql:3306/solararc_pro
      - PYTHON_ENV=production
      - LOG_LEVEL=INFO
    depends_on:
      - solararc-mysql

  # 前端服务
  - name: frontend
    type: container
    source: ./frontend
    dockerfile: Dockerfile
    ports:
      - port: 80
        type: HTTP
    env:
      - VITE_API_BASE_URL=https://your-backend.zeabur.app/api/v1
    domains:
      - domain: solararc.zeabur.app
```

---

### 7.5 环境变量配置

#### 7.5.1 后端环境变量 (.env.backend)
```env
# 数据库配置（Zeabur自动注入）
DATABASE_URL=${MYSQL_URL}
DB_POOL_SIZE=10
DB_MAX_OVERFLOW=5

# API配置
API_HOST=0.0.0.0
API_PORT=8000
CORS_ORIGINS=https://solararc.zeabur.app,https://www.yourdomain.com

# 高德地图配置
AMAP_API_KEY=your_amap_api_key_here

# 时区配置
TZ=Asia/Shanghai

# 日志配置
LOG_LEVEL=INFO
LOG_FORMAT=json

# 安全配置
SECRET_KEY=your-secret-key-here-change-in-production
ALLOWED_ORIGINS=https://solararc.zeabur.app
```

#### 7.5.2 前端环境变量 (.env.frontend)
```env
# API地址（生产环境）
VITE_API_BASE_URL=https://your-backend.zeabur.app/api/v1

# 高德地图配置
VITE_AMAP_KEY=your_amap_key_here
VITE_MAP_CENTER_LNG=116.397428
VITE_MAP_CENTER_LAT=39.90923
VITE_MAP_DEFAULT_ZOOM=12

# 功能开关
VITE_ENABLE_ANALYSIS=true
VITE_ENABLE_EXPORT=true

# 应用配置
VITE_APP_NAME=SolarArc Pro
VITE_APP_VERSION=1.0.0

# 默认城市
VITE_DEFAULT_CITY=北京
VITE_DEFAULT_CITY_CODE=110000
```

---

### 7.6 部署步骤

#### 7.6.1 部署数据库
1. 在Zeabur控制台选择 "Services"
2. 点击 "New Service" → "Database" → "MySQL"
3. 等待数据库创建完成
4. 记录数据库连接信息（自动注入到环境变量）

#### 7.6.2 部署后端
1. 选择 "New Service" → "Git" → 选择你的GitHub仓库
2. Zeabur会自动检测到 `backend/Dockerfile`
3. 配置环境变量（DATABASE_URL等）
4. 部署完成后会获得一个 `*.zeabur.app` 域名

#### 7.6.3 部署前端
1. 选择 "New Service" → "Git" → 选择你的GitHub仓库
2. Zeabur会自动检测到 `frontend/Dockerfile`
3. 配置环境变量（VITE_API_BASE_URL指向后端域名）
4. 设置自定义域名（可选）

#### 7.6.4 配置自定义域名
1. 在前端服务设置中选择 "Domains"
2. 添加自定义域名（如 `solararc.example.com`）
3. 按照提示配置DNS解析：
   - 类型: CNAME
   - 名称: solararc
   - 值: cname.zeabur.app
4. Zeabur会自动申请SSL证书（Let's Encrypt）

---

### 7.7 国内访问优化

#### 7.7.1 使用国内镜像加速
**Docker构建加速**（backend/Dockerfile）:
```dockerfile
# 使用阿里云镜像
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories
```

**NPM安装加速**（frontend/Dockerfile）:
```dockerfile
# 使用淘宝镜像
RUN npm config set registry https://registry.npmmirror.com
```

**Python包加速**（backend/Dockerfile）:
```dockerfile
# 使用清华镜像
RUN pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
```

#### 7.7.2 CDN加速（可选）
如果需要全球加速，可以配置CDN：
1. 推荐使用 **腾讯云CDN** 或 **阿里云CDN**
2. 源站设置为 Zeabur 提供的域名
3. 开启HTTPS回源

---

### 7.8 成本控制

#### 7.8.1 免费额度优化
| 资源 | 优化策略 | 节省成本 |
|------|----------|----------|
| CPU | 降低worker数量 | 从2个→1个worker |
| 内存 | 使用gunicorn预加载 | 节省约30%内存 |
| 数据库 | 定期清理缓存表 | 控制存储在1GB内 |
| 带宽 | 启用Gzip压缩 | 减少70%传输量 |

#### 7.8.2 付费方案（如果超出免费额度）
| 方案 | 配置 | 价格 |
|------|------|------|
| 基础版 | 0.5 vCPU, 512MB RAM | ¥10/月 |
| 标准版 | 1 vCPU, 1GB RAM | ¥30/月 |
| 专业版 | 2 vCPU, 2GB RAM | ¥80/月 |

**建议**: 初期使用免费版，用户量增长后再升级

---

### 7.9 监控与日志

#### 7.9.1 Zeabur内置监控
- CPU/内存使用率实时监控
- 服务健康状态检查
- 访问日志查看
- 错误日志聚合

#### 7.9.2 外部监控（免费）
| 服务 | 用途 |
|------|------|
| **UptimeRobot** | 服务可用性监控（每5分钟检查一次）|
| **Sentry** | 前端错误追踪（5K事件/月免费）|
| **阿里云日志服务** | 后端日志收集（免费额度）|

---

### 7.10 备份与恢复

#### 7.10.1 数据库备份
Zeabur自动每天备份MySQL数据库，保留7天。

**手动备份**:
```bash
# 通过SSH连接到容器
zeabur ssh backend

# 导出数据库
mysqldump -h solararc-mysql -u root -p solararc_pro > backup.sql
```

#### 7.10.2 恢复数据
```bash
# 恢复数据库
mysql -h solararc-mysql -u root -p solararc_pro < backup.sql
```

---

### 7.11 开发环境配置

#### 7.11.1 后端开发环境
```bash
# 进入后端目录
cd backend

# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt

# 复制环境变量
cp .env.example .env
# 编辑.env文件，配置数据库等

# 启动开发服务器
uvicorn main:app --reload --port 8000
```

#### 7.11.2 前端开发环境
```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 复制环境变量
cp .env.example .env.local
# 编辑.env.local文件

# 启动开发服务器
npm run dev
```

---

### 7.12 CI/CD自动化

#### 7.12.1 连接GitHub
1. 在Zeabur中点击 "Import from GitHub"
2. 授权Zeabur访问你的仓库
3. 选择要部署的分支（通常是 `main`）

#### 7.12.2 自动部署触发条件
- 推送代码到 `main` 分支
- 创建新的 Pull Request
- 手动在控制台点击 "Redeploy"

#### 7.12.3 部署前测试（可选）
在 `zeabur.yml` 中配置：
```yaml
services:
  - name: backend
    hooks:
      - type: prebuild
        command: pytest tests/
```

---

### 7.13 故障排查

#### 7.13.1 常见问题

**问题1: 内存不足**
- 症状: 服务频繁重启
- 解决:
  - 减少gunicorn worker数量
  - 优化数据库查询
  - 清理不必要的Python包

**问题2: 数据库连接失败**
- 症状: API返回500错误
- 解决:
  - 检查DATABASE_URL环境变量
  - 确认数据库服务已启动
  - 查看数据库日志

**问题3: 前端无法访问后端**
- 症状: CORS错误
- 解决:
  - 在后端CORS_ORIGINS添加前端域名
  - 检查VITE_API_BASE_URL配置

#### 7.13.2 日志查看
```bash
# 查看实时日志
zeabur logs backend --follow

# 查看最近100行日志
zeabur logs backend --tail 100
```

---

### 7.14 自建服务器备用方案

如果Zeabur免费额度不够，可以使用国内云服务器：

**推荐配置**:
- **阿里云轻量应用服务器**: 2核2G, ¥108/年
- **腾讯云轻量应用服务器**: 2核2G, ¥100/年
- **华为云弹性云服务器**: 2核4G, ¥200/年

**部署方式**: 使用相同的Docker Compose配置（见下一章）

---

## 八、实施计划

### 8.1 开发阶段划分

#### 第一阶段: 基础架构 (2周)
- [x] 项目初始化 (前后端)
- [ ] 数据库设计与创建
- [ ] 基础API框架搭建
- [ ] 前端路由与布局

#### 第二阶段: 核心算法 (3周)
- [ ] 太阳位置计算算法实现
- [ ] 阴影计算引擎开发
- [ ] 空间数据运算优化
- [ ] 单元测试编写

#### 第三阶段: 可视化开发 (3周)
- [ ] 地图组件集成
- [ ] 3D建筑渲染
- [ ] 阴影实时渲染
- [ ] 时间轴与仪表盘

#### 第四阶段: 业务功能 (2周)
- [ ] 日照分析功能
- [ ] 阴影重叠分析
- [ ] 极端日期对比
- [ ] 用户配置保存

#### 第五阶段: 优化与测试 (2周)
- [ ] 性能优化
- [ ] 集成测试
- [ ] 用户体验优化
- [ ] 文档编写

---

### 8.2 技术风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| Mapbox Token限制 | 地图底图无法使用 | 使用MapLibre + OpenStreetMap |
| 大量建筑计算缓慢 | 用户体验差 | 实施LOD分级加载 + 缓存策略 |
| MySQL空间索引性能差 | 查询慢 | 迁移至PostgreSQL + PostGIS |
| 免费额度耗尽 | 服务不可用 | 实施自建服务器备用方案 |

---

## 九、扩展功能规划 (未来版本)

### 9.1 v2.0 规划
- 气象数据集成 (云层遮挡计算)
- 室内采光分析
- 光伏发电量计算
- 移动端响应式优化

### 9.2 商业化方向 (可选)
- SaaS订阅模式
- 私有部署方案
- API付费调用
- 定制化分析报告

---

## 十、附录

### 10.1 参考文档
- [pvlib文档](https://pvlib-python.readthedocs.io/)
- [Shapely文档](https://shapely.readthedocs.io/)
- [Mapbox GL JS文档](https://docs.mapbox.com/mapbox-gl-js/)
- [Deck.gl文档](https://deck.gl/)
- [MySQL空间数据文档](https://dev.mysql.com/doc/refman/8.0/en/spatial-indexing.html)
- [ECharts文档](https://echarts.apache.org/zh/index.html)
- [Workbox文档](https://developer.chrome.com/docs/workbox/)
- [reportlab文档](https://reportlab.com/documentation/)

### 10.2 开源协议
本项目采用 **MIT License**, 可自由使用、修改、分发。

---

**文档更新记录**:
- v2.1 (2026-01-29): 数据库设计优化，所有主键ID改为VARCHAR(36) UUID类型
- v2.0 (2026-01-29): 新增用户认证模块、移动端适配、可视化分析统计模块
- v1.1 (2026-01-29): 新增中国国内用户特色功能，部署方案改为Zeabur平台
- v1.0 (2026-01-29): 初始版本发布

**维护者**: SolarArc Pro 开发团队
