# SolarArc Pro - 配置文件说明

## 📋 目录

- [一、配置文件清单](#一配置文件清单)
- [二、Docker配置](#二docker配置)
- [三、环境变量配置](#三环境变量配置)
- [四、部署配置](#四部署配置)
- [五、CI/CD配置](#五cicd配置)
- [六、使用指南](#六使用指南)

---

## 一、配置文件清单

### 1.1 项目根目录

```
solararc-pro/
├── .env.example                    # Docker Compose环境变量模板
├── zeabur.yml                      # Zeabur部署配置
├── docker-compose.yml              # Docker Compose编排文件
├── backend/
│   ├── Dockerfile                  # 后端Docker镜像配置
│   ├── .env.example                # 后端环境变量模板
│   └── requirements.txt            # Python依赖列表
├── frontend/
│   ├── Dockerfile                  # 前端Docker镜像配置
│   ├── nginx.conf                  # Nginx配置文件
│   ├── .env.example                # 前端环境变量模板
│   └── package.json                # Node依赖列表
├── scripts/
│   └── deploy.sh                   # 一键部署脚本
└── .github/workflows/
    └── deploy.yml                  # GitHub Actions CI/CD配置
```

---

## 二、Docker配置

### 2.1 后端Dockerfile

**文件**: `backend/Dockerfile`

**特点**:
- 多阶段构建，优化镜像大小
- 使用Python 3.10官方镜像
- 安装空间计算依赖（GEOS, PROJ）
- 使用gunicorn + uvicorn workers
- 健康检查配置
- 非root用户运行

**关键配置**:
```dockerfile
# 安装运行时依赖
RUN apt-get update && apt-get install -y \
    libgeos3d1 \
    libproj15

# 启动命令
CMD ["gunicorn", "main:app", \
     "--workers", "2", \
     "--worker-class", "uvicorn.workers.UvicornWorker"]
```

### 2.2 前端Dockerfile

**文件**: `frontend/Dockerfile`

**特点**:
- 多阶段构建（构建阶段 + Nginx运行）
- Node 18 Alpine镜像
- 使用淘宝npm镜像加速
- Nginx Alpine运行时
- Gzip压缩优化

**关键配置**:
```dockerfile
# 构建阶段
FROM node:18-alpine AS builder
RUN npm config set registry https://registry.npmmirror.com
RUN npm run build

# 运行阶段
FROM nginx:alpine
COPY --from=builder /build/dist /usr/share/nginx/html
```

### 2.3 Nginx配置

**文件**: `frontend/nginx.conf`

**功能**:
- SPA路由支持
- Gzip压缩
- 静态资源缓存
- API代理（可选）
- 安全头配置

**关键配置**:
```nginx
# SPA路由
location / {
    try_files $uri $uri/ /index.html;
}

# Gzip压缩
gzip on;
gzip_types text/plain text/css application/json application/javascript;

# 静态资源缓存
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### 2.4 Docker Compose

**文件**: `docker-compose.yml`

**服务组成**:
- MySQL 8.0
- Redis 7 (可选)
- Backend (FastAPI)
- Frontend (Nginx + React)

**网络配置**:
- 自定义bridge网络
- 服务间通过服务名通信

---

## 三、环境变量配置

### 3.1 后端环境变量

**文件**: `backend/.env.example`

**分类**:

#### 必需变量
```env
DATABASE_URL=mysql+pymysql://user:pass@localhost:3306/solararc_pro
SECRET_KEY=your-secret-key-here
APP_ENV=production
```

#### 可选变量
```env
# 数据库
DB_POOL_SIZE=10
DB_MAX_OVERFLOW=5

# Redis
REDIS_URL=redis://localhost:6379/0

# CORS
CORS_ORIGINS=http://localhost:3000,https://solararc.zeabur.app

# 地图API
AMAP_API_KEY=your_amap_key

# 日志
LOG_LEVEL=INFO
```

### 3.2 前端环境变量

**文件**: `frontend/.env.example`

**必需变量**:
```env
VITE_API_BASE_URL=http://localhost:8000/api/v1
VITE_AMAP_KEY=your_amap_key
```

**可选变量**:
```env
# 地图
VITE_MAP_CENTER_LNG=116.397428
VITE_MAP_CENTER_LAT=39.90923
VITE_MAP_DEFAULT_ZOOM=12

# 默认城市
VITE_DEFAULT_CITY=北京
VITE_DEFAULT_CITY_CODE=110000

# 功能开关
VITE_ENABLE_ANALYSIS=true
VITE_ENABLE_3D=true
```

### 3.3 Docker Compose环境变量

**文件**: `.env.example`

**主要配置**:
```env
FRONTEND_PORT=80
BACKEND_PORT=8000
MYSQL_PORT=3306
MYSQL_ROOT_PASSWORD=solararc_root_2026
MYSQL_DATABASE=solararc_pro
MYSQL_USER=solararc
MYSQL_PASSWORD=solararc_pass_2026
```

---

## 四、部署配置

### 4.1 Zeabur配置

**文件**: `zeabur.yml`

**配置项**:

#### 数据库
```yaml
databases:
  - name: solararc-mysql
    type: mysql
    version: "8.0"
```

#### 后端服务
```yaml
services:
  - name: backend
    type: container
    source: ./backend
    ports:
      - port: 8000
        type: HTTP
    env:
      - DATABASE_URL=${MYSQL_URL}
      - AMAP_API_KEY=${AMAP_API_KEY}
    resources:
      cpu: 0.2
      memory: 256Mi
```

#### 前端服务
```yaml
services:
  - name: frontend
    type: container
    source: ./frontend
    ports:
      - port: 80
    domains:
      - solararc.zeabur.app
```

---

## 五、CI/CD配置

### 5.1 GitHub Actions

**文件**: `.github/workflows/deploy.yml`

**工作流程**:

```
┌─────────────┐
│  推送代码   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  代码检查   │  ← Lint Backend & Frontend
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  运行测试   │  ← Test Backend & Frontend
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  构建镜像   │  ← Build Docker Images
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  部署服务   │  ← Deploy to Zeabur
└─────────────┘
```

**触发条件**:
- Push到main分支 → 生产环境
- Push到dev分支 → 开发环境
- Pull Request → 仅测试

**必需的Secrets**:
- `ZEABUR_TOKEN` - Zeabur API令牌
- `ZEABUR_PROJECT_ID` - Zeabur项目ID
- `AMAP_API_KEY` - 高德地图API密钥
- `SECRET_KEY` - 应用密钥

---

## 六、使用指南

### 6.1 本地开发

#### 步骤1: 安装依赖
```bash
# 后端
cd backend
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt

# 前端
cd frontend
npm install
```

#### 步骤2: 配置环境变量
```bash
# 后端
cd backend
cp .env.example .env
# 编辑.env文件

# 前端
cd frontend
cp .env.example .env.local
# 编辑.env.local文件
```

#### 步骤3: 启动服务
```bash
# 后端
cd backend
uvicorn main:app --reload --port 8000

# 前端（新终端）
cd frontend
npm run dev
```

### 6.2 Docker部署

#### 步骤1: 配置环境变量
```bash
cp .env.example .env
# 编辑.env文件
```

#### 步骤2: 一键部署
```bash
chmod +x scripts/deploy.sh
./scripts/deploy.sh prod
```

或手动部署：
```bash
docker-compose up -d
```

#### 步骤3: 查看日志
```bash
docker-compose logs -f
```

### 6.3 Zeabur部署

#### 步骤1: 准备仓库
```bash
git add .
git commit -m "Ready for Zeabur deployment"
git push origin main
```

#### 步骤2: 连接Zeabur
1. 登录 [zeabur.com](https://zeabur.com)
2. 创建新项目
3. 点击 "Import from GitHub"
4. 选择你的仓库

#### 步骤3: 配置服务
1. Zeabur会自动识别 `zeabur.yml`
2. 配置环境变量
3. 部署MySQL数据库
4. 部署后端服务
5. 部署前端服务

#### 步骤4: 配置自定义域名（可选）
1. 在服务设置中添加域名
2. 配置DNS解析：CNAME → `cname.zeabur.app`
3. 等待SSL证书自动申请

### 6.4 监控与维护

#### 查看服务状态
```bash
# Docker Compose
docker-compose ps

# Zeabur
# 在控制台查看服务状态
```

#### 查看日志
```bash
# Docker Compose
docker-compose logs backend
docker-compose logs frontend

# Zeabur
zeabur logs backend --follow
```

#### 重启服务
```bash
# Docker Compose
docker-compose restart backend

# Zeabur
# 在控制台点击 "Redeploy"
```

#### 数据库备份
```bash
# Docker Compose
docker-compose exec mysql mysqldump -u root -p solararc_pro > backup.sql

# Zeabur（自动备份）
# 每天自动备份，保留7天
```

---

## 七、故障排查

### 7.1 常见问题

#### 问题1: 数据库连接失败
```bash
# 检查数据库是否运行
docker-compose ps mysql

# 检查环境变量
echo $DATABASE_URL

# 查看数据库日志
docker-compose logs mysql
```

#### 问题2: 前端无法访问后端
```bash
# 检查CORS配置
echo $CORS_ORIGINS

# 检查后端是否运行
curl http://localhost:8000/api/v1/health

# 检查前端API配置
echo $VITE_API_BASE_URL
```

#### 问题3: 内存不足
```yaml
# zeabur.yml - 减少资源占用
resources:
  cpu: 0.1
  memory: 128Mi

# backend/Dockerfile - 减少worker数量
CMD ["gunicorn", "main:app", "--workers", "1"]
```

---

## 八、最佳实践

### 8.1 安全建议

1. **不要提交敏感信息**
   - 所有 `.env` 文件都在 `.gitignore` 中
   - 使用环境变量存储密钥
   - 在Zeabur中配置Secrets

2. **定期更新依赖**
   ```bash
   # 后端
   pip list --outdated
   pip install --upgrade package-name

   # 前端
   npm outdated
   npm update package-name
   ```

3. **使用HTTPS**
   - Zeabur自动配置HTTPS
   - 不要禁用SSL验证

### 8.2 性能优化

1. **启用缓存**
   - Redis缓存热点数据
   - Nginx静态资源缓存
   - 前端使用浏览器缓存

2. **数据库优化**
   - 添加空间索引
   - 使用连接池
   - 定期清理日志

3. **前端优化**
   - 代码分割
   - 懒加载
   - 图片压缩

### 8.3 监控建议

1. **设置告警**
   - CPU使用率 > 80%
   - 内存使用率 > 90%
   - 服务宕机

2. **日志分析**
   - 错误日志
   - 慢查询日志
   - 访问日志

3. **定期备份**
   - 数据库自动备份
   - 手动备份重要配置

---

## 九、相关文档

- [Zeabur部署指南](./Zeabur部署配置指南.md)
- [需求设计文档](./需求设计文档.md)
- [Zeabur官方文档](https://zeabur.com/docs)
- [Docker官方文档](https://docs.docker.com/)

---

**文档版本**: v1.0
**更新日期**: 2026-01-29
**维护者**: SolarArc Pro 开发团队
