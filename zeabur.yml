# ============================================
# SolarArc Pro - Zeabur平台部署配置
# ============================================
# 官方文档: https://zeabur.com/docs

version: 1

# ============================================
# 数据库配置
# ============================================
databases:
  # MySQL数据库
  - name: solararc-mysql
    type: mysql
    version: "8.0"
    # 可选：设置数据库密码
    # password: ${MYSQL_PASSWORD}

# 可选：Redis缓存
  # - name: solararc-redis
  #   type: redis
  #   version: "7.0"

# ============================================
# 服务配置
# ============================================
services:
  # --------------------------------------------
  # 后端服务
  # --------------------------------------------
  - name: backend
    type: container
    source: ./backend
    dockerfile: Dockerfile

    # 端口配置
    ports:
      - port: 8000
        type: HTTP
        # 可选：自定义域名
        domain:
          - api.solararc.zeabur.app

    # 环境变量
    env:
      # 数据库配置（Zeabur自动注入）
      - DATABASE_URL=${MYSQL_URL}
      - REDIS_URL=${REDIS_URL}

      # 应用配置
      - APP_NAME=SolarArc Pro
      - APP_ENV=production
      - DEBUG=false
      - LOG_LEVEL=INFO
      - TZ=Asia/Shanghai

      # CORS配置
      - CORS_ORIGINS=https://solararc.zeabur.app,https://www.solararc.pro

      # 高德地图API
      - AMAP_API_KEY=${AMAP_API_KEY}

      # 安全密钥
      - SECRET_KEY=${SECRET_KEY}

      # 数据库连接池
      - DB_POOL_SIZE=10
      - DB_MAX_OVERFLOW=5

    # 依赖服务
    depends_on:
      - solararc-mysql
      # - solararc-redis

    # 资源限制（根据需要调整）
    resources:
      cpu: 0.2
      memory: 256Mi

    # 可选：自动扩缩容（付费功能）
    # autoscaling:
    #   min: 1
    #   max: 3
    #   target_cpu: 70
    #   target_memory: 80

  # --------------------------------------------
  # 前端服务
  # --------------------------------------------
  - name: frontend
    type: container
    source: ./frontend
    dockerfile: Dockerfile

    # 端口配置
    ports:
      - port: 80
        type: HTTP
        # 主域名
        domain:
          - solararc.zeabur.app
          # 可选：自定义域名
          # - www.solararc.pro

    # 环境变量
    env:
      # API地址（指向后端域名）
      - VITE_API_BASE_URL=https://api.solararc.zeabur.app/api/v1

      # 高德地图配置
      - VITE_AMAP_KEY=${AMAP_API_KEY}
      - VITE_MAP_CENTER_LNG=116.397428
      - VITE_MAP_CENTER_LAT=39.90923
      - VITE_MAP_DEFAULT_ZOOM=12

      # 默认城市
      - VITE_DEFAULT_CITY=北京
      - VITE_DEFAULT_CITY_CODE=110000

      # 应用配置
      - VITE_APP_NAME=SolarArc Pro
      - VITE_APP_VERSION=1.0.0

    # 资源限制
    resources:
      cpu: 0.1
      memory: 128Mi

    # 依赖服务（前端不直接依赖后端，但需要配置API地址）
    # depends_on:
    #   - backend

# ============================================
# 定时任务（可选）
# ============================================
# cronjobs:
#   - name: daily-shadow-calculation
#     schedule: "0 2 * * *"  # 每天凌晨2点
#     command: "python -m backend.app.tasks.calculate_daily_shadows"
#     service: backend

# ============================================
# 预览部署配置（可选）
# ============================================
# pull_request:
#   backend:
#     env:
#       - APP_ENV=staging
#   frontend:
#     env:
#       - VITE_API_BASE_URL=https://backend-preview.zeabur.app/api/v1
#     domains:
#       - preview-*.zeabur.app
