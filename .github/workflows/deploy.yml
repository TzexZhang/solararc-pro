# ============================================
# SolarArc Pro - GitHub Actions CI/CD配置
# ============================================
# 功能：
# 1. 代码推送到main分支自动部署到Zeabur生产环境
# 2. 代码推送到dev分支自动部署到Zeabur开发环境
# 3. Pull Request自动运行测试
# 4. 每次提交运行代码检查

name: SolarArc Pro CI/CD

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

# 环境变量
env:
  ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
  ZEABUR_PROJECT_ID: ${{ secrets.ZEABUR_PROJECT_ID }}

# ============================================
# 任务定义
# ============================================
jobs:
  # ============================================
  # 代码检查（后端）
  # ============================================
  lint-backend:
    name: Lint Backend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout代码
        uses: actions/checkout@v4

      - name: 设置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install black flake8 mypy pylint

      - name: 代码格式检查（Black）
        run: black --check .

      - name: 代码风格检查（Flake8）
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: 类型检查（MyPy）
        run: mypy app/ --ignore-missing-imports || true

  # ============================================
  # 代码检查（前端）
  # ============================================
  lint-frontend:
    name: Lint Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout代码
        uses: actions/checkout@v4

      - name: 设置Node.js环境
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: 安装依赖
        run: npm ci

      - name: ESLint检查
        run: npm run lint || true

      - name: TypeScript类型检查
        run: npm run type-check || true

  # ============================================
  # 运行测试（后端）
  # ============================================
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: solararc_test
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306

    steps:
      - name: Checkout代码
        uses: actions/checkout@v4

      - name: 设置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: 运行测试
        env:
          DATABASE_URL: mysql+pymysql://root:test_password@localhost:3306/solararc_test
        run: |
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=html

      - name: 上传测试覆盖率
        uses: codecov/codecov-action@v3
        with:
          files: ./backend/coverage.xml
          flags: backend
          name: backend-coverage

  # ============================================
  # 运行测试（前端）
  # ============================================
  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout代码
        uses: actions/checkout@v4

      - name: 设置Node.js环境
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: 安装依赖
        run: npm ci

      - name: 运行单元测试
        run: npm run test -- --coverage --watchAll=false

      - name: 上传测试覆盖率
        uses: codecov/codecov-action@v3
        with:
          files: ./frontend/coverage/coverage-final.json
          flags: frontend
          name: frontend-coverage

  # ============================================
  # 构建Docker镜像
  # ============================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [lint-backend, lint-frontend, test-backend, test-frontend]
    if: github.event_name == 'push'

    steps:
      - name: Checkout代码
        uses: actions/checkout@v4

      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录到Docker Hub（可选）
        if: github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: 构建后端镜像
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: false
          tags: solararc-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: 构建前端镜像
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: false
          tags: solararc-frontend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # 部署到Zeabur（生产环境）
  # ============================================
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://solararc.zeabur.app

    steps:
      - name: Checkout代码
        uses: actions/checkout@v4

      - name: 安装Zeabur CLI
        run: |
          curl -s https://zeabur.com/install.sh | bash
          echo "$HOME/.zeabur/bin" >> $GITHUB_PATH

      - name: 登录Zeabur
        run: |
          zeabur login --token ${{ secrets.ZEABUR_TOKEN }}

      - name: 部署到Zeabur
        run: |
          zeabur deploy \
            --project-id ${{ secrets.ZEABUR_PROJECT_ID }} \
            --branch main

      - name: 健康检查
        run: |
          sleep 30
          curl -f https://solararc.zeabur.app/health || exit 1

      - name: 部署通知
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            生产环境部署完成！
            分支: ${{ github.ref }}
            提交: ${{ github.sha }}
            作者: ${{ github.actor }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  # ============================================
  # 部署到Zeabur（开发环境）
  # ============================================
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'
    environment:
      name: development
      url: https://solararc-dev.zeabur.app

    steps:
      - name: Checkout代码
        uses: actions/checkout@v4

      - name: 安装Zeabur CLI
        run: |
          curl -s https://zeabur.com/install.sh | bash
          echo "$HOME/.zeabur/bin" >> $GITHUB_PATH

      - name: 登录Zeabur
        run: |
          zeabur login --token ${{ secrets.ZEABUR_TOKEN }}

      - name: 部署到Zeabur
        run: |
          zeabur deploy \
            --project-id ${{ secrets.ZEABUR_PROJECT_ID }} \
            --branch dev

      - name: 健康检查
        run: |
          sleep 30
          curl -f https://solararc-dev.zeabur.app/health || exit 1
